---
//Imports des composants
import Layout from "../../layouts/Layout.astro";
import BlobTransition from "../../components/ui/BlobTransition.astro";
import CardArtisteEtOeuvre from "../../components/ui/CardArtisteEtOeuvre.astro";
import ImagePB from "../../components/ImagePB.astro";


//Imports des fonctions backend
import { getOneOeuvreBySlug, getImageUrl, getOeuvresByArtistId, getSuggestedOeuvres } from "../../lib/backend";
const slug = Astro.params.id;
const oeuvres = await getOneOeuvreBySlug(slug);

// Rediriger vers 404 si l'œuvre n'existe pas
if (!oeuvres) {
  return Astro.redirect('/404');
}

const imageRecord = oeuvres?.expand?.oeuvres_images[0] ;
const UrlImage = getImageUrl(imageRecord, imageRecord.images[0]);

// Récupérer les autres oeuvres du même artiste
const artistId = oeuvres?.expand?.artiste_id?.id;
const autresOeuvres = artistId ? await getOeuvresByArtistId(artistId, oeuvres.id) : [];

//Récupérer 3 suggestions d'œuvres avec stratégie SEO (Catégorie → Promotion MMI → Récentes)
const excludeIds = [oeuvres.id, ...autresOeuvres.map(o => o.id)];
const oeuvresSuggestions = await getSuggestedOeuvres(oeuvres, excludeIds, 3);

// URL de l'image à précharger (sans thumbnail pour éviter double transformation)
const pbUrl = import.meta.env.POCKETBASE_URL;
const preloadImageUrl = `${pbUrl}/api/files/${imageRecord.collectionId}/${imageRecord.id}/${imageRecord.images[0]}`;
---

<Layout title={oeuvres.title + " - " + oeuvres.expand.artiste_id.name + " | MMI Art 26"} description={"Découvrez l'œuvre " + oeuvres.title + " de " + oeuvres.expand.artiste_id.name + ", présentée dans l'exposition MMI Art 26. Plongez dans l'univers créatif de nos artistes talentueux."} preloadImage={preloadImageUrl}>
    <main class="overflow-hidden">
        
        <div class="w-[80%] lg:w-[50%] 2xl:w-[45%] mx-auto relative lg:mt-10 2xl:mt-10">
            <ImagePB 
                collection={imageRecord.collectionId}
                record={imageRecord.id}
                file={imageRecord.images[0]}
                alt={oeuvres.title}
                width={1200}
                height={1200}
                loading="eager"
                fetchpriority="high"
                aspectRatio={false}
                objectFit="contain"
                class="w-full h-auto"
            />
        </div>
        
        <div class="relative -z-10 -mt-44 lg:-mt-60 2xl:-mt-100">
            <BlobTransition position="top" color="#111111" deformStrength={0.3} />
        </div>
        
        <section class="black-section relative">
            <header class="flex flex-col items-center gap-2">
                <h1 class="text-center uppercase">{oeuvres.title}, {oeuvres.year}</h1>
                <span class="">{oeuvres.category}</span>
            </header>
            
            <div class="mt-8 lg:mt-16 flex flex-col lg:flex-row lg:gap-12 2xl:gap-20">
                {/* Colonne gauche : Artiste */}
                <a href={`/artistes/${oeuvres.expand.artiste_id.slug}`} class="lg:w-[35%] 2xl:w-[30%] flex flex-col items-center gap-4 hover:opacity-80 transition-opacity mb-8 lg:mb-0">
                    <div class="w-32 lg:w-40 2xl:w-50 aspect-square rounded-full overflow-hidden">
                        <ImagePB 
                            collection={oeuvres.expand.artiste_id.collectionId}
                            record={oeuvres.expand.artiste_id.id}
                            file={oeuvres.expand.artiste_id.avatar}
                            alt={oeuvres.expand.artiste_id.name}
                            width={400}
                            height={400}
                            thumb="400x400"
                            class="w-full h-full object-cover"
                        />
                    </div>
                    <div class="text-center">
                        <h3 class="font-bold text-base lg:text-xl 2xl:text-2xl text-secondary">{oeuvres.expand.artiste_id.name}</h3>
                        <p class="text-xs lg:text-sm 2xl:text-base text-secondary mt-2">{oeuvres.expand.artiste_id.mmi_year}</p>
                    </div>
                </a>

                {/* Colonne droite : Description et techniques */}
                <div class="lg:w-[65%] 2xl:w-[70%]">
                    <div>
                        <h3 class="font-bold">Description</h3>
                        <p class="mt-4">
                            {oeuvres.description}
                        </p>
                    </div>
                    <div class="mt-8">
                        <h3 class="font-bold">Techniques utilisées</h3>
                        <p class="mt-4">
                            {oeuvres.technique}
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <section class="pt-10 lg:pt-16 2xl:pt-20 black-section lg:pb-20 pb-12">
            <header>
                <h2>Du même artiste</h2>
            </header>
            {autresOeuvres.length > 0 ? (
                <ul class="flex flex-col items-center mt-12 gap-12 md:flex-row md:flex-wrap md:justify-center">
                    {autresOeuvres.map((oeuvre, index) => (
                        <li>
                            <CardArtisteEtOeuvre oeuvre={oeuvre} variant={(index % 3) + 1} />
                        </li>
                    ))}
                </ul>
            ) : (
                <p class="text-center mt-8 text-secondary">Aucune autre œuvre de cet artiste pour le moment.</p>
            )}
        </section>
         <BlobTransition position="bottom" color="#111111" deformStrength={0.3} />

        <section>
            <header>
                <h2>Autres oeuvres</h2>
            </header>
            {oeuvresSuggestions.length > 0 ? (
                <ul class="flex flex-col items-center mt-12 gap-12 md:flex-row md:flex-wrap md:justify-center">
                    {oeuvresSuggestions.map((oeuvre, index) => (
                        <li>
                            <CardArtisteEtOeuvre oeuvre={oeuvre} variant={(index % 3) + 1} />
                        </li>
                    ))}
                </ul>
            ) : (
                <p class="text-center mt-8 text-secondary">Aucune autre œuvre disponible pour le moment.</p>
            )}
            <div class="btn-wrapper">
                <a class="btn" href="/exposition">Teaser des oeuvres</a>
            </div>
        </section>
    </main>
</Layout>