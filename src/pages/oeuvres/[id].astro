---
//Imports des composants
import Layout from "../../layouts/Layout.astro";
import BlobTransition from "../../components/ui/BlobTransition.astro";
import CardArtisteEtOeuvre from "../../components/ui/CardArtisteEtOeuvre.astro";
import ImagePB from "../../components/ImagePB.astro";


//Imports des fonctions backend
import { getOneOeuvreBySlug, getImageUrl, getOeuvresByArtistId, getSuggestedOeuvres } from "../../lib/backend";
const slug = Astro.params.id;
const oeuvres = await getOneOeuvreBySlug(slug);

// Rediriger vers 404 si l'œuvre n'existe pas
if (!oeuvres) {
  return Astro.redirect('/404');
}

const imageRecord = oeuvres?.expand?.oeuvres_images[0] ;
const UrlImage = getImageUrl(imageRecord, imageRecord.images[0]);

// Récupérer les autres oeuvres du même artiste
const artistId = oeuvres?.expand?.artiste_id?.id;
const autresOeuvres = artistId ? await getOeuvresByArtistId(artistId, oeuvres.id) : [];

//Récupérer 3 suggestions d'œuvres avec stratégie SEO (Catégorie → Promotion MMI → Récentes)
const excludeIds = [oeuvres.id, ...autresOeuvres.map(o => o.id)];
const oeuvresSuggestions = await getSuggestedOeuvres(oeuvres, excludeIds, 3);

---

<Layout title={oeuvres.title + " - " + oeuvres.expand.artiste_id.name + " | MMI Art 26"} description={"Découvrez l'œuvre " + oeuvres.title + " de " + oeuvres.expand.artiste_id.name + ", présentée dans l'exposition MMI Art 26. Plongez dans l'univers créatif de nos artistes talentueux."}>
    <main class="overflow-hidden">
        
        <div class="w-[80%] mx-auto relative">
            <ImagePB 
                collection={imageRecord.collectionId}
                record={imageRecord.id}
                file={imageRecord.images[0]}
                alt={oeuvres.title}
                width={1200}
                height={1200}
                loading="eager"
                class="w-full h-auto object-contain"
            />
        </div>
        
        <div class="relative -z-10 -mt-44">
            <BlobTransition position="top" color="#111111" deformStrength={0.3} />
        </div>
        
        <section class="black-section -z-10">
            <header class="flex flex-col items-center gap-2">
                <h1 class="text-center uppercase">{oeuvres.title}, {oeuvres.year}</h1>
                <span class="">{oeuvres.category}</span>
            </header>
            <div class="mt-8">
                <h3 class="font-bold">Description</h3>
                <p class="mt-4">
                    {oeuvres.description}
                </p>
            </div>
            <div class="mt-8">
                <h3 class="font-bold">Techniques utilisées</h3>
                <p class="mt-4">
                    {oeuvres.technique}
                </p>
            </div>
        </section>

        <section class="pt-0 -mt-2 black-section">
            <header>
                <h2>Du même artiste</h2>
            </header>
            {autresOeuvres.length > 0 ? (
                <ul class="flex flex-col items-center mt-12 gap-12 md:flex-row md:flex-wrap md:justify-center">
                    {autresOeuvres.map((oeuvre, index) => (
                        <li>
                            <CardArtisteEtOeuvre oeuvre={oeuvre} variant={(index % 3) + 1} />
                        </li>
                    ))}
                </ul>
            ) : (
                <p class="text-center mt-8 text-secondary">Aucune autre œuvre de cet artiste pour le moment.</p>
            )}
        </section>
         <BlobTransition position="bottom" color="#111111" deformStrength={0.3} />

        <section>
            <header>
                <h2>Autres oeuvres</h2>
            </header>
            {oeuvresSuggestions.length > 0 ? (
                <ul class="flex flex-col items-center mt-12 gap-12 md:flex-row md:flex-wrap md:justify-center">
                    {oeuvresSuggestions.map((oeuvre, index) => (
                        <li>
                            <CardArtisteEtOeuvre oeuvre={oeuvre} variant={(index % 3) + 1} />
                        </li>
                    ))}
                </ul>
            ) : (
                <p class="text-center mt-8 text-secondary">Aucune autre œuvre disponible pour le moment.</p>
            )}
            <div class="btn-wrapper">
                <a class="btn" href="/exposition">Teaser des oeuvres</a>
            </div>
        </section>
    </main>
</Layout>