---
import Layout from '../layouts/Layout.astro';
import AnimatedH1 from '../components/ui/AnimatedH1.astro';
import BlobTransition from '../components/ui/BlobTransition.astro';
import BlobDynamic from '../components/ui/BlobDynamic.astro';
import TimeBeforeDate from '../components/ui/TimeBeforeDate.astro';
import Oeuvre1 from '../assets/images/oeuvre_1.webp';
import Oeuvre2 from '../assets/images/oeuvre_2.webp';
import Oeuvre3 from '../assets/images/oeuvre_3.webp';
import ImgExpo from '../assets/images/image_expo.webp';
import ContactCTA from '../components/ui/ContactCTA.astro';
import FAQ from '../components/ui/FAQ.astro';

import { getImageUrl, getOneOeuvre, GetArtistById } from '../lib/backend';
import CardArtisteEtOeuvre from '../components/ui/CardArtisteEtOeuvre.astro';
import ImagePB from '../components/ImagePB.astro';

const projectIds = [
	"sohru0uj4e8ppd7",
	"d3rflpfwzcxjequ",
	"j6p699ckzjviy4p",
	"das19nwl3b355if",
	"z6c9nik0bfsnxzu"
];

const artistsIds = [
	"z6aisibgwcazrt9",
	"gu9fv2orsdfckbl",
	"mslywn9hbt3usnn",
]

const oeuvres = await Promise.all(
	projectIds.map(id => getOneOeuvre(id))
);

const artistes = await Promise.all(
	artistsIds.map(id => GetArtistById(id))
);

// Précharger l'image centrale du carrousel (3ème œuvre, index 2)
const pbUrl = import.meta.env.POCKETBASE_URL;
const centralOeuvre = oeuvres[2];
const centralImageRecord = centralOeuvre?.expand?.oeuvres_images[0];
const preloadCarouselImage = centralImageRecord 
	? `${pbUrl}/api/files/${centralImageRecord.collectionId}/${centralImageRecord.id}/${centralImageRecord.images[0]}?thumb=800x800`
	: null;
---

<Layout preloadImage={preloadCarouselImage}>
	<main class="overflow-hidden">
		<section class="mb-12 lg:pt-8 lg:pb-15 lg:mb-0 2xl:pt-15 2xl:pb-30 2xl:mb-0">
			<div class="hidden lg:block absolute top-0 left-0 lg:mt-26 lg:ml-2 lg:w-75 lg:h-75 2xl:mt-24 2xl:ml-4 2xl:w-116 2xl:h-116">
				<img src={Oeuvre1.src} alt="Oeuvre">
			</div>
			<header class="lg:flex lg:flex-col lg:justify-center lg:items-center lg:ml-46 2xl:ml-40">
				<AnimatedH1 variant="accueil" text="Bienvenue à MMI ART 26" />
				<p class="mt-12 lg:text-sm 2xl:text-lg lg:mt-2 lg:w-2/4 lg:ml-16 2xl:mt-14 2xl:ml-50">
					Découvrez l'exposition d'art des étudiants en MMI de 2026, un parcours créatif qui met en avant les projets numériques, installations interactives et expériences visuelles conçus en formation Multimédia et Internet. 
				</p>
				
			</header>
			<div class="flex justify-end mt-6 lg:mr-52 2xl:mr-70">
					<a href="/exposition" class="btn">L'exposition</a>
				</div>
			<div class="hidden lg:block absolute top-0 right-0 lg:mt-22 lg:mr-8 lg:w-45 lg:h-45 2xl:mt-24 2xl:mr-8 2xl:w-70 2xl:h-70">
				<img src={Oeuvre2.src} alt="Oeuvre">
			</div>
			<div class="absolute top-30 right-12 lg:static lg:mt-20 lg:text-center 2xl:mt-30">
				<span class="lg:text-xl 2xl:text-2xl font-semibold text-xs">22 au 24 janvier 2026</span>
			</div>
			
			<div class="lg:mt-12 lg:flex lg:justify-end lg:items-center 2xl:mt-34">
				<div class="flex flex-col mt-12 gap-2 lg:gap-10 lg:mr-12 2xl:gap-16 2xl:mr-24">
					<p class="font-uni-sans text-lg text-left lg:text-3xl 2xl:text-4xl">L'exposition est dans</p>
					<TimeBeforeDate />
				</div>
			</div>
			<div class="hidden lg:block absolute lg:-bottom-60 lg:left-35 2xl:-bottom-95 2xl:left-58 mb-20 ml-4 lg:w-40 lg:h-40 2xl:w-63.5 2xl:h-63.5">
				<img src={Oeuvre3.src} alt="Oeuvre">
			</div>
			
		</section>

		<BlobTransition position="top" color="#111111" deformStrength={0.3} />

		{/* Section avec fond noir */}
		<section class="black-section">
			<div>
				{/* Layout desktop : 2 colonnes */}
				<div class="flex flex-col lg:flex-row lg:gap-12 xl:gap-20 items-center justify-center">
					{/* Colonne gauche : Titre + Textes */}
					<div class="flex-1">
						<header>
							<h2 class="text-secondary">MMI Art 26</h2>
						</header>
						<div class="text-content mt-6 lg:mt-10">
							<p>
								Le programme est pensé pour les futurs étudiants MMI, les visiteurs de la JPO et toutes les personnes curieuses de découvrir concrètement les projets réalisés en formation multimédia. 
							</p>
							<p>
								Entre visites guidées, démonstrations de projets et temps d'échanges avec les étudiants, chaque créneau vous permet d'explorer l'univers MMI et de poser toutes vos questions sur la formation.
							</p>
						</div>
					</div>
					
					{/* Colonne droite : Image */}
					<div class="flex-1 flex justify-center items-center mt-10 lg:mt-0">
						<div class="w-60 md:w-70 lg:w-90 2xl:w-125 justify-center mx-auto items-center">
							<BlobDynamic imageUrl={ImgExpo.src} variant={1} />
						</div>
					</div>
				</div>
			
				{/* Blobs d'informations */}
				<ul class="flex mt-12 flex-col gap-8 items-center md:flex-row md:justify-center md:flex-wrap md:gap-12 lg:gap-28 2xl:gap-40 lg:mt-24 2xl:mt-32">
					<li class="w-50 lg:w-46 2xl:w-76">
						<BlobDynamic color='#FAFAFA' variant={1}>
							<div class="w-full h-full flex items-center justify-center bg-white">
								<p class="text-black text-center font-bold px-4 text-4xl font-uni-sans">22 au 24 Janvier <br> 2026</p>
							</div>
						</BlobDynamic>
					</li>
					<li class="w-50 lg:w-46 2xl:w-76">
						<BlobDynamic color='#FAFAFA' variant={3}>
							<div class="w-full h-full flex items-center justify-center bg-white">
								<p class="text-black text-center font-bold px-4 text-5xl font-uni-sans">3 jours pour l'art</p>
							</div>
						</BlobDynamic>
					</li>
					<li class="w-50 lg:w-46 2xl:w-76">
						<BlobDynamic color='#FAFAFA' variant={4}>
							<div class="w-full h-full flex items-center justify-center bg-white">
								<p class="text-black text-center font-bold px-4 text-2xl font-uni-sans">22 & 23 jan : 12h - 13h30 <br> 24 jan : 9h - 17h</p>
							</div>
						</BlobDynamic>
					</li>
				</ul>
				<div class="btn-wrapper">
					<a href="/exposition" class="btn-white">Voir l'exposition</a>
				</div>
			</div>
		</section>

		{/* Vague du bas */}
		<BlobTransition position="bottom" color="#111111" deformStrength={0.3} />

		<section class="px-0">
			<header class="ml-9 md:ml-12 lg:ml-20 2xl:ml-30">
				<h2>Les oeuvres</h2>
			</header>
			<div id="carousel-container">
				<ul class="flex justify-start items-center mt-12 gap-0" id="carousel-track">
					{/* Premier set d'oeuvres */}
					{oeuvres.map((oeuvre, index) => (
						<li 
							class="carousel-item w-96 md:w-70 lg:w-87.5 xl:w-120 shrink-0 transition-all duration-500 ease-out"
							data-index={index}
						>
							<a 
								href={`/oeuvres/${oeuvre.slug}`}
								class="block group cursor-pointer"
								aria-label={`Voir l'œuvre ${oeuvre.title}`}
							>
								<div class="relative overflow-hidden">
									<ImagePB 
										collection={oeuvre.expand.oeuvres_images[0].collectionId}
										record={oeuvre.expand.oeuvres_images[0].id}
										file={oeuvre.expand.oeuvres_images[0].images[0]}
										alt={oeuvre.title}
										width={800}
										height={800}
										thumb="800x800"
										loading={index === 2 ? "eager" : "lazy"}
										fetchpriority={index === 2 ? "high" : "auto"}
										class="w-96 h-96 md:w-70 md:h-70 lg:w-87.5 lg:h-87.5 xl:w-120 xl:h-120 object-cover"
									/>
								</div>
								<h3 class="bg-primary text-secondary text-center border-secondary border-x text-sm! transition-all duration-300 group-hover:bg-secondary group-hover:text-primary py-2">
									{oeuvre.expand.artiste_id.name}
								</h3>
							</a>
						</li>
					))}
					{/* Dupliquer pour l'effet infini */}
					{oeuvres.map((oeuvre, index) => (
						<li 
							class="carousel-item w-96 md:w-70 lg:w-87.5 xl:w-120 shrink-0 transition-all duration-500 ease-out"
							data-index={index + oeuvres.length}
							data-duplicate="true"
						>
							<a 
								href={`/oeuvres/${oeuvre.slug}`}
								class="block group cursor-pointer"
								aria-label={`Voir l'œuvre ${oeuvre.title}`}
							>
								<div class="relative overflow-hidden">
									<ImagePB 
										collection={oeuvre.expand.oeuvres_images[0].collectionId}
										record={oeuvre.expand.oeuvres_images[0].id}
										file={oeuvre.expand.oeuvres_images[0].images[0]}
										alt={oeuvre.title}
										width={800}
										height={800}
										thumb="800x800"
										loading="lazy"
										class="w-96 h-96 md:w-70 md:h-70 lg:w-87.5 lg:h-87.5 xl:w-120 xl:h-120 object-cover"
									/>
								</div>
								<h3 class="bg-primary text-secondary text-center border-secondary border-x text-sm! transition-all duration-300 group-hover:bg-secondary group-hover:text-primary py-2">
									{oeuvre.expand.artiste_id.name}
								</h3>
							</a>
						</li>
					))}
				</ul>
			</div>
			<div class="btn-wrapper">
				<a href="/exposition" class="btn">Teaser des oeuvres</a>
			</div>
		</section>

		<section class="">
			<header>
				<h2 class="">Les Artistes</h2>
			</header>
			<ul class="ul-flex">
				{artistes.map((artiste, index) => (
					<li>
						<CardArtisteEtOeuvre artiste={artiste} variant={(index % 3) + 1} />
					</li>
				))}
			</ul>
			<div>
				<div class="btn-wrapper">
					<a href="/artistes" class="btn">Les artistes</a>
				</div>
			</div>
		</section>

		<section class="">
		<div class="flex flex-col md:flex-row justify-center items-center">
			<div class="flex-1 md:w-[50%]">
				<header>
					<h2 class="">Impossible de venir ?</h2>
				</header>
				<div>
					<div class="text-content">
						<p>Impossible de venir à l'exposition MMI sur place ? Découvrez la visite virtuelle 360° de l'expo et explorez les projets d'art numérique des étudiants comme si vous étiez dans la salle.</p>
						<p>Plongez au cœur des œuvres interactives, installations et créations des étudiants MMI grâce à une expérience de visite en ligne accessible depuis n'importe où.</p>
					</div>
				</div>
			</div>
			
			<div class="flex-1 flex justify-center items-center mt-10 md:mt-0">
				<div class="w-60 md:w-70 lg:w-90 2xl:w-125">
					<BlobDynamic imageUrl={ImgExpo.src} variant={2} />
				</div>
			</div>
		</div>
			<div class="btn-wrapper">
				<a href="/visite-virtuelle" class="btn">Visite 360°</a>
			</div>
		</section>

		<section class="lg:mb-20 2xl:mb-40">
			<header>
				<h2 class="text-center md:mb-10 ">Faq</h2>
			</header>
			<div class="flex flex-col justify-center items-center lg:flex-row lg:gap-4 lg:items-center">	
					
				<div class="w-full lg:w-1/2 flex flex-col items-center mt-12 lg:mt-12">
					<FAQ />
				</div>
				<div class="w-full lg:w-1/2 flex justify-center items-center mt-12 lg:mt-12">
					<ContactCTA />
				</div>
			</div>
			
		</section>

	</main>
</Layout>

<style>
	/* Carrousel infini automatique */
	#carousel-container {
		overflow: hidden;
		position: relative;
		width: 100%;
	}
	
	/* Gradient fade sur les bords */
	#carousel-container::before,
	#carousel-container::after {
		content: "";
		position: absolute;
		top: 0;
		height: 100%;
		width: 200px;
		z-index: 20;
		pointer-events: none;
	}
	
	#carousel-container::before {
		left: 0;
		background: linear-gradient(to right, rgb(250 250 250) 0%, rgba(250, 250, 250, 0) 100%);
	}
	
	#carousel-container::after {
		right: 0;
		background: linear-gradient(to left, rgb(250 250 250) 0%, rgba(250, 250, 250, 0) 100%);
	}
	
	/* Animation de scroll infini */
	@keyframes infiniteScroll {
		0% {
			transform: translateX(0);
		}
		100% {
			transform: translateX(calc(-384px * 5)); /* -w-96 * 5 items */
		}
	}
	
	@media (min-width: 768px) {
		@keyframes infiniteScroll {
			0% {
				transform: translateX(0);
			}
			100% {
				transform: translateX(calc(-280px * 5)); /* -w-70 * 5 items */
			}
		}
	}
	
	@media (min-width: 1024px) {
		@keyframes infiniteScroll {
			0% {
				transform: translateX(0);
			}
			100% {
				transform: translateX(calc(-350px * 5)); /* -w-87.5 * 5 items */
			}
		}
	}
	
	@media (min-width: 1280px) {
		@keyframes infiniteScroll {
			0% {
				transform: translateX(0);
			}
			100% {
				transform: translateX(calc(-480px * 5)); /* -w-120 * 5 items */
			}
		}
	}
	
	#carousel-track {
		animation: infiniteScroll 30s linear infinite;
		will-change: transform;
	}
	
	/* Effet de perspective sur les items */
	.carousel-item {
		opacity: 0.7;
		transform: scale(0.95);
		transition: all 0.3s ease;
	}
	
	.carousel-item:hover,
	.carousel-item.is-featured {
		opacity: 1;
		transform: scale(1);
		z-index: 10;
	}
	
	/* Quand on survole un item, tous les autres (y compris is-featured) redeviennent normaux */
	#carousel-track:has(.carousel-item:hover) .carousel-item:not(:hover) {
		opacity: 0.7;
		transform: scale(0.95);
	}
</style>

<script>
	document.addEventListener('astro:page-load', () => {
		const container = document.getElementById('carousel-container');
		const items = document.querySelectorAll('.carousel-item');
		
		if (!container || !items.length) return;
		
		// Fonction pour trouver l'œuvre la plus proche du centre
		function updateCenteredItem() {
			const containerRect = container.getBoundingClientRect();
			const containerCenter = containerRect.left + containerRect.width / 2;
			
			let closestItem: HTMLElement | null = null;
			let closestDistance = Infinity;
			
			items.forEach((item) => {
				const itemRect = item.getBoundingClientRect();
				const itemCenter = itemRect.left + itemRect.width / 2;
				const distance = Math.abs(containerCenter - itemCenter);
				
				if (distance < closestDistance) {
					closestDistance = distance;
					closestItem = item as HTMLElement;
				}
			});
			
			// Retirer is-featured de tous les items et l'ajouter au plus proche
			items.forEach((item) => {
				if (item === closestItem) {
					item.classList.add('is-featured');
				} else {
					item.classList.remove('is-featured');
				}
			});
		}
		
		// Mettre à jour toutes les 100ms pendant l'animation
		setInterval(updateCenteredItem, 100);
		
		// Initialiser
		updateCenteredItem();
	});
</script>
