---
import BlobDynamic from '../ui/BlobDynamic.astro';
import { getImageUrl } from '../../lib/backend';
import ImagePB from '../ImagePB.astro';

const { artiste, oeuvre, variant = 1 } = Astro.props;

// Déterminer si c'est un artiste ou une oeuvre
const isArtiste = !!artiste;
const isOeuvre = !!oeuvre;

// Pour artiste
const artisteName = isArtiste ? artiste.name : null;
const artisteAvatarUrl = isArtiste && artiste.avatar ? getImageUrl(artiste, artiste.avatar) : null;
const artisteSlug = isArtiste ? artiste.slug : null;

// Données pour ImagePB (artiste)
const artisteImageData = isArtiste && artiste.avatar ? {
  collection: artiste.collectionId,
  record: artiste.id,
  file: artiste.avatar
} : null;

// Pour oeuvre
const oeuvreTitre = isOeuvre ? oeuvre.title : null;
const oeuvreImageRecord = isOeuvre && oeuvre.expand?.oeuvres_images?.[0];
const oeuvreImageUrl = oeuvreImageRecord && oeuvreImageRecord.images?.[0] 
  ? getImageUrl(oeuvreImageRecord, oeuvreImageRecord.images[0]) 
  : null;
const oeuvreArtisteName = isOeuvre ? oeuvre.expand?.artiste_id?.name : null;
const oeuvreSlug = isOeuvre ? oeuvre.slug : null;

// Données pour ImagePB (oeuvre)
const oeuvreImageData = oeuvreImageRecord && oeuvreImageRecord.images?.[0] ? {
  collection: oeuvreImageRecord.collectionId,
  record: oeuvreImageRecord.id,
  file: oeuvreImageRecord.images[0]
} : null;

const imageUrl = isArtiste ? artisteAvatarUrl : oeuvreImageUrl;
const imageData = isArtiste ? artisteImageData : oeuvreImageData;
const mainTitle = isArtiste ? artisteName : oeuvreTitre;
const linkHref = isArtiste ? `/artistes/${artisteSlug}` : `/oeuvres/${oeuvreSlug}`;

---
<a href={linkHref} class="w-60 h-60 md:w-76 md:h-76 lg:w-84 lg:h-84 2xl:w-90 2xl:h-90 bg-secondary flex flex-col items-center gap-4 lg:justify-between shadow-md rounded-md hover:scale-102 transition-transform p-4 lg:py-8 text-center relative mx-auto overflow-hidden">
    {isOeuvre && oeuvreArtisteName && (
        <p class="absolute top-2 right-2 text-xs md:text-sm text-primary font-medium max-w-[calc(100%-1rem)] truncate">{oeuvreArtisteName}</p>
    )}
    <div class="w-40 lg:w-56 2xl:w-64 mt-6 lg:mt-0 shrink-0 flex items-center justify-center">
        <BlobDynamic 
          imageUrl={imageUrl} 
          imageData={imageData}
          variant={variant} 
        />
    </div>
    <h3 class="text-primary text-xs lg:text-base w-full px-2 break-words line-clamp-2">{mainTitle}</h3>
</a>